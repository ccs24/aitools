define("aitoolsub_cluster/cluster_manager",["aitoolsub_cluster/tabulatorlib","jquery","core/ajax","core/notification"],(function(Tabulator,$,Ajax,Notification){var ClusterManager={config:{contextid:0,wwwroot:"",sesskey:"",userid:0},clustersTable:null,valuemapData:{},currentCluster:null,init:function(){console.log("ClusterManager: Initializing..."),window.ClusterConfig&&(this.config=window.ClusterConfig),this.initEventHandlers(),this.loadValueMapData(),this.initClustersTable(),this.loadStats(),console.log("ClusterManager: Initialized successfully")},initEventHandlers:function(){var self=this;$("#create-cluster-btn, #create-first-cluster-btn").on("click",(function(){self.showCreateClusterModal()})),$("#status-filter, #market-filter").on("change",(function(){self.applyFilters()})),$("#search-input").on("input",this.debounce((function(){self.applyFilters()}),500)),$("#clear-filters-btn").on("click",(function(){self.clearFilters()})),$('input[name="view-mode"]').on("change",(function(){self.toggleViewMode($(this).attr("id"))})),$("#cluster-form").on("submit",(function(e){e.preventDefault(),self.saveCluster()})),$("#refresh-markets-btn").on("click",(function(){self.loadValueMapData(!0)}))},loadValueMapData:function(forceRefresh){var self=this;if(!forceRefresh&&Object.keys(this.valuemapData).length>0)this.populateDropdowns();else{console.log("ClusterManager: Loading ValueMapDoc data...");Ajax.call([{methodname:"aitoolsub_cluster_get_valuemap_data",args:{fields:["market","industry","role"],search:"",limit:100}}])[0].done((function(response){console.log("ClusterManager: ValueMapDoc data loaded",response),response.error?(console.warn("ClusterManager: ValueMapDoc error:",response.error),Notification.addNotification({message:"ValueMapDoc warning: "+response.error,type:"warning"}),self.valuemapData={fields:{},context_data:[],statistics:{}}):self.valuemapData=response,self.populateDropdowns()})).fail((function(error){console.error("ClusterManager: Error loading ValueMapDoc data",error),self.valuemapData={fields:{},context_data:[],statistics:{}},self.populateDropdowns(),Notification.addNotification({message:"Could not load market data. You can still type custom values.",type:"warning"})}))}},populateDropdowns:function(){console.log("ClusterManager: Populating dropdowns...");var marketFilter=$("#market-filter");marketFilter.empty().append('<option value="">All Markets</option>');var clusterMarket=$("#cluster-market");clusterMarket.empty().append('<option value="">Select or type custom market...</option>'),this.valuemapData.fields&&this.valuemapData.fields.market&&this.valuemapData.fields.market.forEach((function(item){var option=$("<option></option>").attr("value",item.value).text(item.display);marketFilter.append(option.clone()),clusterMarket.append(option.clone())})),this.makeSelectEditable("#cluster-market")},makeSelectEditable:function(selector){var $select=$(selector),$wrapper=$('<div class="editable-select-wrapper"></div>'),$input=$('<input type="text" class="form-control editable-select-input">');$select.wrap($wrapper),$select.after($input),$select.on("change",(function(){""!==$(this).val()&&0!==$(this).find("option:selected").length||($input.show().focus(),$select.hide())})),$input.on("blur",(function(){if(""===$(this).val().trim())$input.hide(),$select.show();else{var customValue=$(this).val().trim();0===$select.find('option[value="'+customValue+'"]').length&&$select.append($("<option></option>").attr("value",customValue).text(customValue+" (custom)")),$select.val(customValue)}})),$input.hide()},initClustersTable:function(){var self=this;if(console.log("ClusterManager: Initializing clusters table..."),void 0===Tabulator)return console.error("ClusterManager: Tabulator not loaded, using simple table"),void this.loadClustersSimple();this.clustersTable=new Tabulator("#clusters-table",{height:500,layout:"fitColumns",placeholder:"No clusters found",pagination:"local",paginationSize:25,paginationSizeSelector:[10,25,50,100],movableColumns:!0,resizableRows:!0,responsiveLayout:"hide",columns:[{title:"Name",field:"name",width:200,headerFilter:"input",formatter:function(cell){var data=cell.getData(),html="<strong>"+data.name+"</strong>";return data.description&&(html+='<br><small class="text-muted">'+data.description.substring(0,60)+(data.description.length>60?"...":"")+"</small>"),html}},{title:"Market",field:"market",width:150,headerFilter:"select",headerFilterParams:{values:!0}},{title:"Status",field:"status",width:120,headerFilter:"select",headerFilterParams:{"":"All",planning:"Planning",active:"Active",paused:"Paused",completed:"Completed"},formatter:function(cell){var status=cell.getValue();return'<span class="badge bg-'+{planning:"secondary",active:"success",paused:"warning",completed:"info"}[status]+'">'+status.charAt(0).toUpperCase()+status.slice(1)+"</span>"}},{title:"Companies",field:"company_count",width:100,hozAlign:"center",formatter:function(cell){return'<span class="badge bg-info">'+cell.getValue()+"</span>"}},{title:"Contacts",field:"person_count",width:100,hozAlign:"center",formatter:function(cell){return'<span class="badge bg-warning">'+cell.getValue()+"</span>"}},{title:"Messages",field:"message_count",width:100,hozAlign:"center",formatter:function(cell){return'<span class="badge bg-primary">'+cell.getValue()+"</span>"}},{title:"Modified",field:"modified_date",width:120,formatter:function(cell){return self.formatDate(cell.getValue())}},{title:"Actions",field:"actions",width:200,hozAlign:"center",headerSort:!1,formatter:function(cell){var data=cell.getData();return self.renderActionButtons(data)}}],rowClick:function(e,row){self.viewCluster(row.getData().id)}}),this.loadClusters()},renderActionButtons:function(data){var html='<div class="btn-group btn-group-sm" role="group">';return html+='<button type="button" class="btn btn-outline-primary btn-sm" onclick="ClusterManager.viewCluster('+data.id+')" title="View Details"><i class="fa fa-eye"></i></button>',("manage"===data.access_level||data.is_owner)&&(html+='<button type="button" class="btn btn-outline-secondary btn-sm" onclick="ClusterManager.editCluster('+data.id+')" title="Edit"><i class="fa fa-edit"></i></button>',html+='<button type="button" class="btn btn-outline-danger btn-sm" onclick="ClusterManager.deleteCluster('+data.id+", '"+data.name.replace(/'/g,"\\'")+'\')" title="Delete"><i class="fa fa-trash"></i></button>'),html+="</div>"},loadClusters:function(){var self=this;console.log("ClusterManager: Loading clusters..."),$("#loading-state").show(),$("#empty-state").hide();var request={methodname:"aitoolsub_cluster_get_clusters",args:{filters:this.getCurrentFilters()}};Ajax.call([request])[0].done((function(response){console.log("ClusterManager: Clusters loaded",response),$("#loading-state").hide(),0===response.clusters.length?($("#empty-state").show(),self.clustersTable&&self.clustersTable.clearData()):($("#empty-state").hide(),self.clustersTable?self.clustersTable.setData(response.clusters):self.renderClustersSimple(response.clusters)),self.updatePaginationInfo(response.pagination)})).fail((function(error){console.error("ClusterManager: Error loading clusters",error),$("#loading-state").hide(),Notification.addNotification({message:"Error loading clusters: "+error.message,type:"error"})}))},loadClustersSimple:function(){console.log("ClusterManager: Loading clusters (simple mode)..."),this.loadClusters()},renderClustersSimple:function(clusters){var self=this,html='<div class="table-responsive">';html+='<table class="table table-striped table-hover">',html+="<thead><tr>",html+="<th>Name</th><th>Market</th><th>Status</th>",html+="<th>Companies</th><th>Contacts</th><th>Messages</th>",html+="<th>Modified</th><th>Actions</th>",html+="</tr></thead><tbody>",clusters.forEach((function(cluster){html+="<tr>",html+="<td><strong>"+cluster.name+"</strong>",cluster.description&&(html+='<br><small class="text-muted">'+cluster.description.substring(0,60)+(cluster.description.length>60?"...":"")+"</small>"),html+="</td>",html+="<td>"+(cluster.market||"-")+"</td>",html+='<td><span class="badge bg-'+self.getStatusBadgeClass(cluster.status)+'">'+cluster.status.charAt(0).toUpperCase()+cluster.status.slice(1)+"</span></td>",html+='<td><span class="badge bg-info">'+cluster.company_count+"</span></td>",html+='<td><span class="badge bg-warning">'+cluster.person_count+"</span></td>",html+='<td><span class="badge bg-primary">'+cluster.message_count+"</span></td>",html+="<td>"+self.formatDate(cluster.modified_date)+"</td>",html+="<td>"+self.renderActionButtons(cluster)+"</td>",html+="</tr>"})),html+="</tbody></table></div>",$("#clusters-table-container").html(html)},getCurrentFilters:function(){return{status:$("#status-filter").val(),market:$("#market-filter").val(),search:$("#search-input").val().trim(),limit:50,offset:0}},applyFilters:function(){console.log("ClusterManager: Applying filters..."),this.loadClusters()},clearFilters:function(){console.log("ClusterManager: Clearing filters..."),$("#status-filter").val(""),$("#market-filter").val(""),$("#search-input").val(""),this.loadClusters()},toggleViewMode:function(mode){console.log("ClusterManager: Switching to "+mode),"card-view"===mode?($("#clusters-table-container").hide(),$("#clusters-cards-container").show(),this.loadClustersCards()):($("#clusters-cards-container").hide(),$("#clusters-table-container").show())},loadClustersCards:function(){console.log("ClusterManager: Loading card view..."),$("#clusters-cards").html('<p class="text-center">Card view coming soon...</p>')},showCreateClusterModal:function(){console.log("ClusterManager: Showing create cluster modal..."),this.currentCluster=null,$("#cluster-modal-label").text("Create New Cluster"),$("#cluster-form")[0].reset(),$("#cluster-id").val(""),$("#save-cluster-btn").html('<i class="fa fa-save"></i> Save Cluster'),new bootstrap.Modal(document.getElementById("cluster-modal")).show()},editCluster:function(clusterId){console.log("ClusterManager: Editing cluster "+clusterId);var self=this,request={methodname:"aitoolsub_cluster_get_clusters",args:{filters:{cluster_id:clusterId}}};Ajax.call([request])[0].done((function(response){if(response.clusters.length>0){var cluster=response.clusters[0];self.currentCluster=cluster,$("#cluster-modal-label").text("Edit Cluster"),$("#cluster-id").val(cluster.id),$("#cluster-name").val(cluster.name),$("#cluster-market").val(cluster.market),$("#cluster-description").val(cluster.description),$("#cluster-status").val(cluster.status),$("#save-cluster-btn").html('<i class="fa fa-save"></i> Update Cluster'),new bootstrap.Modal(document.getElementById("cluster-modal")).show()}})).fail((function(error){console.error("ClusterManager: Error loading cluster for edit",error),Notification.addNotification({message:"Error loading cluster data: "+error.message,type:"error"})}))},saveCluster:function(){console.log("ClusterManager: Saving cluster...");var self=this,formData=this.getFormData("#cluster-form"),isEdit=""!==$("#cluster-id").val();if(formData.name.trim()){var methodname=isEdit?"aitoolsub_cluster_update_cluster":"aitoolsub_cluster_create_cluster",args={name:formData.name.trim(),market:formData.market.trim(),description:formData.description.trim(),status:formData.status};isEdit&&(args.cluster_id=parseInt(formData.cluster_id)),$("#save-cluster-btn").prop("disabled",!0).html('<i class="fa fa-spinner fa-spin"></i> Saving...');var request={methodname:methodname,args:args};Ajax.call([request])[0].done((function(response){console.log("ClusterManager: Cluster saved",response),Notification.addNotification({message:response.message,type:"success"}),bootstrap.Modal.getInstance(document.getElementById("cluster-modal")).hide(),self.loadClusters(),self.loadStats()})).fail((function(error){console.error("ClusterManager: Error saving cluster",error),Notification.addNotification({message:"Error saving cluster: "+error.message,type:"error"})})).always((function(){$("#save-cluster-btn").prop("disabled",!1).html('<i class="fa fa-save"></i> Save Cluster')}))}else Notification.addNotification({message:"Cluster name is required",type:"error"})},viewCluster:function(clusterId){console.log("ClusterManager: Viewing cluster "+clusterId),window.location.href=this.config.wwwroot+"/local/aitools/plugins/cluster/view.php?id="+clusterId},deleteCluster:function(clusterId,clusterName){console.log("ClusterManager: Deleting cluster "+clusterId);var self=this;$("#delete-cluster-name").text(clusterName);var modal=new bootstrap.Modal(document.getElementById("delete-cluster-modal"));modal.show(),$("#confirm-delete-btn").off("click").on("click",(function(){$(this).prop("disabled",!0).html('<i class="fa fa-spinner fa-spin"></i> Deleting...');var request={methodname:"aitoolsub_cluster_delete_cluster",args:{cluster_id:clusterId}};Ajax.call([request])[0].done((function(response){console.log("ClusterManager: Cluster deleted",response),Notification.addNotification({message:response.message,type:"success"}),modal.hide(),self.loadClusters(),self.loadStats()})).fail((function(error){console.error("ClusterManager: Error deleting cluster",error),Notification.addNotification({message:"Error deleting cluster: "+error.message,type:"error"})})).always((function(){$("#confirm-delete-btn").prop("disabled",!1).html('<i class="fa fa-trash"></i> Delete Cluster')}))}))},loadStats:function(){console.log("ClusterManager: Loading stats...");Ajax.call([{methodname:"aitoolsub_cluster_get_clusters",args:{filters:{summary_only:!0}}}])[0].done((function(response){console.log("ClusterManager: Stats loaded",response);var totalClusters=response.clusters.length,activeClusters=response.clusters.filter((function(c){return"active"===c.status})).length,totalCompanies=response.clusters.reduce((function(sum,c){return sum+c.company_count}),0),totalPersons=response.clusters.reduce((function(sum,c){return sum+c.person_count}),0);$("#total-clusters").text(totalClusters),$("#active-clusters").text(activeClusters),$("#total-companies").text(totalCompanies),$("#total-persons").text(totalPersons)})).fail((function(error){console.error("ClusterManager: Error loading stats",error)}))},updatePaginationInfo:function(pagination){console.log("ClusterManager: Pagination info",pagination)},getFormData:function(formSelector){var formData={};return $(formSelector).serializeArray().forEach((function(field){formData[field.name]=field.value})),formData},formatDate:function(timestamp){if(!timestamp)return"-";var date=new Date(1e3*timestamp),diffTime=new Date-date,diffDays=Math.floor(diffTime/864e5);return 0===diffDays?"Today":1===diffDays?"Yesterday":diffDays<7?diffDays+"d ago":date.toLocaleDateString()},getStatusBadgeClass:function(status){return{planning:"secondary",active:"success",paused:"warning",completed:"info"}[status]||"secondary"},debounce:function(func,wait){var timeout;return function(){var context=this,args=arguments,later=function(){timeout=null,func.apply(context,args)};clearTimeout(timeout),timeout=setTimeout(later,wait)}}};return window.ClusterManager=ClusterManager,{init:ClusterManager.init.bind(ClusterManager)}}));

//# sourceMappingURL=cluster_manager.min.js.map