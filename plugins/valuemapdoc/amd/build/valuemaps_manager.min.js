/**
 * ValueMaps Manager JavaScript Module
 * Optimized for cross-course/activity value map entries display
 * Handles 1-10 activities with 5-50 entries each (~500 max entries)
 *
 * @copyright  2024 Local AI Tools
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("aitoolsub_valuemapdoc/valuemaps_manager",["jquery","core/ajax","core/notification"],(function($,Ajax,Notification){var table=null,config=window.valuemapsConfig||{},allData=[],selectedRows=[],currentStatistics={};return{init:function(){var columnsElement=document.querySelector("#valuemap-columns");if(columnsElement&&columnsElement.textContent){var columns;try{columns=JSON.parse(columnsElement.textContent)}catch(e){return void this.showErrorState("Invalid column configuration")}Array.isArray(columns)?this.waitForTabulator(columns):this.showErrorState("Column configuration is not valid")}else this.showErrorState("Column configuration not found")},waitForTabulator:function(columns){var self=this;void 0!==window.Tabulator?(this.bindEvents(),this.loadData(columns)):setTimeout((function(){self.waitForTabulator(columns)}),100)},bindEvents:function(){var self=this;$("#refresh-data").on("click",(function(){self.init()})),$("#export-data").on("click",(function(){self.showExportOptions()})),$("#clear-filters").on("click",(function(){self.clearFilters()})),$("#filter-course, #filter-activity").on("change",(function(){self.applyFilters()})),$("#search-entries").on("input",(function(){self.applyFilters()})),$("#retry-loading").on("click",(function(){self.init()})),$("#toggle-fullscreen").on("click",(function(){self.toggleFullscreen()}))},loadData:function(columns){var self=this;this.showLoadingState(),Ajax.call([{methodname:"aitoolsub_valuemapdoc_get_all_entries_global",args:{userid:config.userid||0,page:0,limit:0}}])[0].done((function(data){if(allData=data.entries||[],currentStatistics=data.statistics||{},self.updateStatistics(currentStatistics),self.populateFilterOptions(currentStatistics),console.log("Using static columns from DOM:",columns),console.log("Static columns count:",columns.length),allData.length>0){var groupedData=self.processDataWithNativeGrouping(allData);self.initializeTableWithGrouping(columns,groupedData),self.showTableState()}else self.showEmptyState()})).fail((function(error){self.showErrorState(error.message||"Failed to load entries"),Notification.exception(error)}))},buildUserColumns:function(userFields,levelConfig){var fieldTitles={market:"Market",industry:"Industry",role:"Role",businessgoal:"Business Goal",strategy:"Strategy",difficulty:"Difficulty",situation:"Situation",statusquo:"Status Quo",coi:"Cost of Inaction",differentiator:"Differentiator",impact:"Impact",newstate:"New State",successmetric:"Success Metric",impactstrategy:"Impact Strategy",impactbusinessgoal:"Impact Business Goal",impactothers:"Impact Others",proof:"Proof",time2results:"Time to Results",quote:"Quote",clientname:"Client Name"},columns=[];return userFields.forEach((function(fieldName){columns.push({title:fieldTitles[fieldName]||fieldName,field:fieldName,hozAlign:"left",headerSort:!0,width:150,headerFilter:"input",headerFilterPlaceholder:"Filter..."})})),columns},processDataWithNativeGrouping:function(entries){return 0===entries.length?[]:(entries.forEach((function(entry){entry.course_activity_group=entry.course_name+" â†’ "+entry.activity_name,entry.view_activity_url=M.cfg.wwwroot+"/mod/valuemapdoc/view.php?id="+entry.cmid,entry.edit_url=M.cfg.wwwroot+"/mod/valuemapdoc/edit.php?id="+entry.cmid+"&entryid="+entry.id})),entries)},updateStatistics:function(stats){$("#stat-total-entries").text(stats.total_entries||0),$("#stat-unique-courses").text(stats.unique_courses||0),$("#stat-unique-activities").text(stats.unique_activities||0),$(".dashboard-summary").length>0&&($(".dashboard-summary .entries-count").text(stats.total_entries||0),$(".dashboard-summary .courses-count").text(stats.unique_courses||0),$(".dashboard-summary .activities-count").text(stats.unique_activities||0))},populateFilterOptions:function(stats){var courseSelect=$("#filter-course");courseSelect.find("option:not(:first)").remove(),stats.courses_list&&stats.courses_list.length>0&&stats.courses_list.forEach((function(course){courseSelect.append('<option value="'+course+'">'+course+"</option>")}));var activitySelect=$("#filter-activity");activitySelect.find("option:not(:first)").remove(),stats.activities_list&&stats.activities_list.length>0&&stats.activities_list.forEach((function(activity){activitySelect.append('<option value="'+activity+'">'+activity+"</option>")}))},prepareColumns:function(userColumns){var self=this,enhancedColumns=[];return enhancedColumns.push({title:"",field:"checkbox",width:40,hozAlign:"center",headerSort:!1,formatter:function(cell){var data=cell.getRow().getData();return data.isSeparator?"":'<input type="checkbox" class="entry-checkbox" data-entry-id="'+data.id+'">'},cellClick:function(e,cell){e.stopPropagation();var data=cell.getRow().getData();data.isSeparator||self.toggleRowSelection(data.id)}}),userColumns.forEach((function(col){enhancedColumns.push({title:col.title,field:col.field,hozAlign:"left",headerSort:!0,width:col.width||150,headerFilter:"input",headerFilterPlaceholder:"Filter "+col.title+"...",editable:!1,formatter:function(cell){var data=cell.getRow().getData();return data.isSeparator?"":data[col.field]||""}})})),enhancedColumns},prepareColumnsForGrouping:function(userColumns){var self=this,enhancedColumns=[];return enhancedColumns.push({title:"",field:"checkbox",width:40,hozAlign:"center",headerSort:!1,formatter:function(cell){return'<input type="checkbox" class="entry-checkbox" data-entry-id="'+cell.getRow().getData().id+'">'},cellClick:function(e,cell){e.stopPropagation(),self.toggleRowSelection(cell.getRow().getData().id)}}),userColumns.forEach((function(col){enhancedColumns.push({title:col.title,field:col.field,hozAlign:"left",headerSort:!0,width:col.width||150,headerFilter:"input",headerFilterPlaceholder:"Filter "+col.title+"...",editable:!1,formatter:function(cell){return cell.getRow().getData()[col.field]||""}})})),enhancedColumns},initializeTableWithGrouping:function(userColumns,data){table&&table.destroy();var enhancedColumns=this.prepareColumnsForGrouping(userColumns);console.log("Enhanced columns before Tabulator:",enhancedColumns),console.log("Enhanced columns count:",enhancedColumns.length),console.log("First few columns:",enhancedColumns.slice(0,5)),table=new Tabulator("#valuemaps-table",{data:data,columns:enhancedColumns,placeholder:"No entries found",pagination:"local",paginationSize:25,paginationSizeSelector:[10,25,50,100],groupBy:"course_activity_group",groupHeader:function(value,count,data,group){var firstItem=data[0];return'<span style="font-weight: bold; color: #007bff; cursor: pointer; display: block; padding: 8px; background: #f8f9fa; border-top: 2px solid #007bff;" onclick="window.open(\''+(firstItem.view_activity_url||M.cfg.wwwroot+"/mod/valuemapdoc/view.php?id="+firstItem.cmid)+"', '_blank')\" title=\"Click to open activity\">"+value+" ("+count+" entries)</span>"},groupStartOpen:!0,groupToggleElement:"header"}),table.on("rowDblClick",(function(e,row){var data=row.getData();window.open(data.edit_url,"_blank")})),this.initializeSelectionTracking()},initializeSelectionTracking:function(){var self=this;$(document).on("change",".entry-checkbox",(function(){var entryId=parseInt($(this).data("entry-id"));$(this).prop("checked")?-1===selectedRows.indexOf(entryId)&&selectedRows.push(entryId):selectedRows=selectedRows.filter((function(id){return id!==entryId})),self.updateSelectionUI()}))},toggleRowSelection:function(entryId){var checkbox=$('.entry-checkbox[data-entry-id="'+entryId+'"]'),isChecked=checkbox.prop("checked");checkbox.prop("checked",!isChecked),isChecked?selectedRows=selectedRows.filter((function(id){return id!==entryId})):-1===selectedRows.indexOf(entryId)&&selectedRows.push(entryId),this.updateSelectionUI()},updateSelectionUI:function(){var count=selectedRows.length,selectionInfo=$(".selection-info");count>0?0===selectionInfo.length?($(".table-controls").prepend('<div class="selection-info alert alert-info d-flex align-items-center me-2"><span class="selection-count">'+count+'</span><span class="ms-1 me-2">entries selected</span><button class="btn btn-sm btn-primary me-1" id="bulk-export">Export Selected</button><button class="btn btn-sm btn-outline-secondary" id="clear-selection">Clear</button></div>'),$("#bulk-export").on("click",function(){this.exportSelected()}.bind(this)),$("#clear-selection").on("click",function(){this.clearSelection()}.bind(this))):selectionInfo.find(".selection-count").text(count):selectionInfo.remove()},applyFilters:function(){if(table){table.clearFilter();var courseFilter=$("#filter-course").val(),activityFilter=$("#filter-activity").val(),searchFilter=$("#search-entries").val();courseFilter&&table.addFilter("course_name","=",courseFilter),activityFilter&&table.addFilter("activity_name","=",activityFilter),searchFilter&&table.addFilter([{field:"market",type:"like",value:searchFilter},{field:"industry",type:"like",value:searchFilter},{field:"role",type:"like",value:searchFilter},{field:"businessgoal",type:"like",value:searchFilter},{field:"course_name",type:"like",value:searchFilter},{field:"activity_name",type:"like",value:searchFilter},{field:"username",type:"like",value:searchFilter}])}},clearFilters:function(){table&&(table.clearFilter(),$("#filter-course").val(""),$("#filter-activity").val(""),$("#search-entries").val(""))},clearSelection:function(){selectedRows=[],$(".entry-checkbox").prop("checked",!1),$(".selection-info").remove()},exportSelected:function(){if(table&&0!==selectedRows.length){var selectedData=table.getData().filter((function(row){return-1!==selectedRows.indexOf(row.id)})),tempDiv=$('<div id="temp-export-table" style="display: none;"></div>');$("body").append(tempDiv);var tempTable=new Tabulator("#temp-export-table",{data:selectedData,columns:this.prepareColumns([]),layout:"fitData"});tempTable.download("csv","selected-valuemap-entries.csv"),setTimeout((function(){tempTable.destroy(),tempDiv.remove()}),1e3)}},showExportOptions:function(){table&&table.download("csv","valuemap-entries-"+(new Date).toISOString().split("T")[0]+".csv")},toggleFullscreen:function(){$("#valuemaps-container").toggleClass("fullscreen"),table&&setTimeout((function(){table.redraw()}),100)},showLoadingState:function(){$("#loading-state").show(),$("#table-state").hide(),$("#empty-state").hide(),$("#error-state").hide()},showTableState:function(){$("#loading-state").hide(),$("#table-state").show(),$("#empty-state").hide(),$("#error-state").hide()},showEmptyState:function(){$("#loading-state").hide(),$("#table-state").hide(),$("#empty-state").show(),$("#error-state").hide()},showErrorState:function(message){$("#loading-state").hide(),$("#table-state").hide(),$("#empty-state").hide(),$("#error-state").show(),$("#error-message").text(message||"An error occurred while loading data.")}}}));

//# sourceMappingURL=valuemaps_manager.min.js.map