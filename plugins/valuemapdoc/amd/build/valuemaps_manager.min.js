define("aitoolsub_valuemapdoc/valuemaps_manager",["jquery","core/ajax","core/notification"],(function($,Ajax,Notification){var table=null,config=window.valuemapsConfig||{},allData=[],processedData=[],selectedRows=[];return{init:function(){console.log("[valuemaps_manager] Module loaded");var columnsElement=document.querySelector("#valuemap-columns");if(columnsElement&&columnsElement.textContent){var columns;try{columns=JSON.parse(columnsElement.textContent),console.log("[valuemaps_manager] Parsed columns:",columns)}catch(e){return void console.error("[valuemaps_manager] Error parsing columns:",e)}Array.isArray(columns)?this.waitForTabulator(columns):console.error("[valuemaps_manager] Columns is not an array")}else console.warn("[valuemaps_manager] Columns not found")},waitForTabulator:function(columns){var self=this;void 0!==window.Tabulator?(console.log("[valuemaps_manager] Tabulator available, initializing..."),this.bindEvents(),this.loadData(columns)):(console.log("[valuemaps_manager] Waiting for Tabulator..."),setTimeout((function(){self.waitForTabulator(columns)}),100))},bindEvents:function(){var self=this;$("#refresh-data").on("click",(function(){self.init()})),$("#export-data").on("click",(function(){self.showExportOptions()})),$("#clear-filters").on("click",(function(){self.clearFilters()})),$("#filter-course, #filter-activity").on("change",(function(){self.applyFilters()})),$("#search-entries").on("input",(function(){self.applyFilters()})),$("#retry-loading").on("click",(function(){self.init()})),$("#toggle-fullscreen").on("click",(function(){self.toggleFullscreen()}))},loadData:function(columns){var self=this;this.showLoadingState(),Ajax.call([{methodname:"aitoolsub_valuemapdoc_get_all_entries_global",args:{userid:config.userid||0}}])[0].done((function(data){allData=data.entries||[],console.log("[valuemaps_manager] Entries loaded:",allData,"records"),allData.length>0&&(console.log("[valuemaps_manager] First entry data:",allData[0]),console.log("[valuemaps_manager] Available fields:",Object.keys(allData[0])),console.log("[valuemaps_manager] Entry market field:",allData[0].market),console.log("[valuemaps_manager] Entry role field:",allData[0].role),console.log("[valuemaps_manager] Entry entry_data field:",allData[0].entry_data)),self.updateStatistics(data.statistics),self.populateFilterOptions(data),(processedData=self.processDataWithSeparators(allData)).length>0?(self.initializeTable(columns,processedData),self.showTableState()):self.showEmptyState()})).fail((function(error){console.error("[valuemaps_manager] Failed to load entries:",error),self.showErrorState(error.message||"Unknown error occurred"),Notification.exception(error)}))},processDataWithSeparators:function(entries){if(0===entries.length)return[];var processedData=[],currentGroup=null;return entries.forEach((function(entry){var groupKey=entry.course_name+" â†’ "+entry.activity_name;currentGroup!==groupKey&&(processedData.push({id:"separator_"+processedData.length,isSeparator:!0,groupTitle:groupKey,course_name:entry.course_name,activity_name:entry.activity_name,cmid:entry.cmid,edit_url:M.cfg.wwwroot+"/mod/valuemapdoc/view.php?id="+entry.cmid}),currentGroup=groupKey),processedData.push(entry)})),processedData},updateStatistics:function(stats){$("#stat-total-entries").text(stats.total_entries||0),$("#stat-unique-courses").text(stats.unique_courses||0),$("#stat-unique-activities").text(stats.unique_activities||0)},populateFilterOptions:function(data){var stats=data.statistics||{},courseSelect=$("#filter-course");courseSelect.find("option:not(:first)").remove(),stats.courses_list&&stats.courses_list.forEach((function(course){courseSelect.append('<option value="'+course+'">'+course+"</option>")}));var activitySelect=$("#filter-activity");activitySelect.find("option:not(:first)").remove(),stats.activities_list&&stats.activities_list.forEach((function(activity){activitySelect.append('<option value="'+activity+'">'+activity+"</option>")}))},prepareColumns:function(columns){var self=this,enhancedColumns=[];return enhancedColumns.push({formatter:function(cell,formatterParams){var data=cell.getRow().getData();return data.isSeparator?'<a href="'+data.edit_url+'" class="btn btn-sm btn-primary" target="_blank"><i class="fa fa-edit"></i> Edit</a>':'<input type="checkbox" class="entry-checkbox" data-entry-id="'+data.id+'">'},width:80,hozAlign:"center",headerSort:!1,cellClick:function(e,cell){var data=cell.getRow().getData();data.isSeparator||(e.stopPropagation(),self.toggleRowSelection(data.id))}}),columns.forEach((function(col){enhancedColumns.push({title:col.title,field:col.field,hozAlign:col.hozAlign||"left",headerSort:!1!==col.headerSort,width:col.width||150,headerFilter:"input",editable:!1,formatter:function(cell){var data=cell.getRow().getData();if(data.isSeparator)return"";var value=data[col.field];return data.id<=8&&console.log("Entry",data.id,"field",col.field,"value:",value),value&&value.length>50?'<div class="text-truncate" style="max-width: '+(col.width-20)+'px;" title="'+value+'">'+value+"</div>":value||""}})})),enhancedColumns.push({title:"Author",field:"username",hozAlign:"left",headerSort:!0,width:120,headerFilter:"input",editable:!1,formatter:function(cell){var data=cell.getRow().getData();if(data.isSeparator)return"";var value=cell.getValue();return 1===data.ismaster?'<i class="fa fa-star text-warning" title="Master entry"></i> '+value:value}}),enhancedColumns},toggleRowSelection:function(entryId){var checkbox=$('input[data-entry-id="'+entryId+'"]'),isSelected=checkbox.prop("checked");isSelected?selectedRows=selectedRows.filter((function(id){return id!==entryId})):selectedRows.push(entryId),checkbox.prop("checked",!isSelected),this.updateSelectionUI()},updateSelectionUI:function(){var count=selectedRows.length,selectionInfo=$(".selection-info");count>0?0===selectionInfo.length?($(".table-controls").prepend('<div class="selection-info alert alert-info py-2 px-3 me-2"><span class="selection-count">'+count+'</span> entries selected <button class="btn btn-sm btn-primary ms-2" id="generate-docs">Generate Documents</button><button class="btn btn-sm btn-secondary ms-1" id="clear-selection">Clear</button></div>'),$("#generate-docs").on("click",this.generateDocuments.bind(this)),$("#clear-selection").on("click",this.clearSelection.bind(this))):selectionInfo.find(".selection-count").text(count):selectionInfo.remove()},clearSelection:function(){selectedRows=[],$(".entry-checkbox").prop("checked",!1),this.updateSelectionUI()},generateDocuments:function(){0!==selectedRows.length?(console.log("Generating documents for entries:",selectedRows),alert("Document generation will be implemented here\nSelected entries: "+selectedRows.length)):alert("Please select entries first")},initializeTable:function(columns,processedData){var self=this,enhancedColumns=this.prepareColumns(columns);(table=new window.Tabulator("#valuemaps-table",{data:processedData,columns:enhancedColumns,layout:"fitDataTable",height:"600px",pagination:"local",paginationSize:20,paginationSizeSelector:[10,20,50,100],movableColumns:!0,resizableRows:!1,selectable:!1,tooltips:!0,placeholder:"No entries to display",persistence:{sort:!0,filter:!0,columns:!0,page:!0},persistenceID:"ai-tools-valuemaps-table",locale:!0,langs:{default:{pagination:{page_size:"Page Size",first:"First",prev:"Prev",next:"Next",last:"Last"},headerFilters:{default:"Filter column..."}}},rowFormatter:function(row){var data=row.getData();if(data.isSeparator){row.getElement().style.backgroundColor="#f8f9fa",row.getElement().style.fontWeight="bold",row.getElement().style.borderTop="2px solid #dee2e6",row.getElement().style.borderBottom="1px solid #dee2e6";var cells=row.getCells();if(cells.length>1){cells[1].getElement().innerHTML='<i class="fa fa-folder-open me-2"></i>'+data.groupTitle,cells[1].getElement().style.fontWeight="bold";for(var i=2;i<cells.length;i++)cells[i].getElement().style.display="none";cells[1].getElement().colSpan=cells.length-1}}else 1===data.ismaster&&(row.getElement().style.backgroundColor="#eaffea",row.getElement().classList.add("ismaster"))}})).on("tableBuilt",(function(){console.log("[valuemaps_manager] Table built successfully"),self.addUserFilterToggle(table)})),table.on("rowDblClick",(function(e,row){var data=row.getData();data.isSeparator||window.open(data.edit_url,"_blank")})),window.valuemapsManager=this},addUserFilterToggle:function(table){var self=this,toolbar=$(".card-header .table-controls");if(0!==toolbar.length){toolbar.append('<button type="button" class="btn btn-sm btn-outline-info ms-2" id="user-filter-toggle"><i class="fa fa-user"></i> My Entries</button>');var showingOnlyMine=!0;$("#user-filter-toggle").on("click",(function(){var $btn=$(this);showingOnlyMine?(table.clearHeaderFilter("username"),$btn.html('<i class="fa fa-users"></i> All Entries'),$btn.removeClass("btn-outline-info").addClass("btn-outline-secondary"),showingOnlyMine=!1):(self.filterToUserEntries(table),$btn.html('<i class="fa fa-user"></i> My Entries'),$btn.removeClass("btn-outline-secondary").addClass("btn-outline-info"),showingOnlyMine=!0)})),this.filterToUserEntries(table)}},filterToUserEntries:function(table){var currentUserId=M.cfg.userid;table.setFilter((function(data){return!!data.isSeparator||data.userid==currentUserId}))},applyFilters:function(){if(table){var courseFilter=$("#filter-course").val(),activityFilter=$("#filter-activity").val(),searchFilter=$("#search-entries").val(),filters=[];if(courseFilter&&filters.push((function(data){return data.isSeparator||data.course_name===courseFilter})),activityFilter&&filters.push((function(data){return data.isSeparator||data.activity_name===activityFilter})),searchFilter&&filters.push((function(data){if(data.isSeparator)return data.groupTitle.toLowerCase().includes(searchFilter.toLowerCase());return["course_name","activity_name","username"].some((function(field){var value=data[field];return value&&value.toLowerCase().includes(searchFilter.toLowerCase())}))})),filters.length>0)table.setFilter((function(data){return filters.every((function(filter){return filter(data)}))}));else $("#user-filter-toggle").hasClass("btn-outline-secondary")?table.clearFilter():this.filterToUserEntries(table)}},clearFilters:function(){if($("#filter-course, #filter-activity").val(""),$("#search-entries").val(""),table){this.filterToUserEntries(table);var $btn=$("#user-filter-toggle");$btn.html('<i class="fa fa-user"></i> My Entries'),$btn.removeClass("btn-outline-secondary").addClass("btn-outline-info")}},showExportOptions:function(){var self=this,exportMenu=$('<div class="dropdown-menu dropdown-menu-end show"><h6 class="dropdown-header">Export Options</h6><button class="dropdown-item" data-format="csv"><i class="fa fa-file-csv me-2"></i>Export as CSV</button><button class="dropdown-item" data-format="json"><i class="fa fa-file-code me-2"></i>Export as JSON</button></div>'),exportBtn=$("#export-data"),offset=exportBtn.offset();exportMenu.css({position:"absolute",top:offset.top+exportBtn.outerHeight(),left:offset.left-150,"z-index":1050}),exportMenu.find("[data-format]").on("click",(function(){var format=$(this).data("format");self.exportData(format),exportMenu.remove()})),$(document).one("click",(function(){exportMenu.remove()})),$("body").append(exportMenu)},exportData:function(format){if(table){var filename="valuemap_entries_"+(new Date).toISOString().slice(0,10),exportData=table.getData().filter((function(row){return!row.isSeparator}));if("csv"===format)table.download("csv",filename+".csv",{},"active");else if("json"===format){var dataStr=JSON.stringify(exportData,null,2),dataBlob=new Blob([dataStr],{type:"application/json"}),url=URL.createObjectURL(dataBlob),link=document.createElement("a");link.href=url,link.download=filename+".json",link.click(),URL.revokeObjectURL(url)}}},toggleFullscreen:function(){$("body").toggleClass("valuemapdoc-fullscreen");var $btn=$("#toggle-fullscreen");$("body").hasClass("valuemapdoc-fullscreen")?($btn.html('<i class="fa fa-compress"></i> Exit Fullscreen'),table&&table.redraw(!0)):($btn.html('<i class="fa fa-expand"></i> Fullscreen'),table&&table.redraw(!0))},showLoadingState:function(){$("#loading-overlay").show(),$("#valuemaps-table").hide(),$("#empty-state").hide(),$("#error-state").hide()},showTableState:function(){$("#loading-overlay").hide(),$("#valuemaps-table").show(),$("#empty-state").hide(),$("#error-state").hide()},showEmptyState:function(){$("#loading-overlay").hide(),$("#valuemaps-table").hide(),$("#empty-state").show(),$("#error-state").hide()},showErrorState:function(message){$("#loading-overlay").hide(),$("#valuemaps-table").hide(),$("#empty-state").hide(),$("#error-state").show(),$("#error-message").text(message)}}}));

//# sourceMappingURL=valuemaps_manager.min.js.map